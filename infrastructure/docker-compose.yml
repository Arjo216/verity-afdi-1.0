version: '3.8'

services:
  # THE CENTRAL COMMAND (Aggregator)
  verity.aggregator:
    image: python:3.9-slim
    container_name: verity_aggregator
    volumes:
      - ..:/app
    working_dir: /app
    # Installs dependencies on startup to keep image light
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt && 
             python -m infrastructure.aggregator_server"
    networks:
      - overwatch_net
    ports:
      - "8080:8080"
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # SECURITY MANAGER
  # SECURITY MANAGER
  demo.manager:
    image: wazuh/wazuh-manager:4.7.2
    hostname: demo.manager
    restart: always
    ports:
      - "1514:1514"
      - "1515:1515"  # <--- NEW: The Enrollment Port
      - "55000:55000"
    environment:
      - INDEXER_URL=https://demo.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword123!
    networks:
      - overwatch_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # SECURITY DATABASE
  demo.indexer:
    image: wazuh/wazuh-indexer:4.7.2
    hostname: demo.indexer
    restart: always
    environment:
      - "OPENSEARCH_INITIAL_ADMIN_PASSWORD=SecretPassword123!"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    mem_limit: 2g
    networks:
      overwatch_net:
        aliases:
          - wazuh.indexer
          - demo.indexer

  # SECURITY DASHBOARD
  demo.dashboard:
    image: wazuh/wazuh-dashboard:4.7.2
    hostname: demo.dashboard
    restart: always
    ports:
      - "443:5601"
    environment:
      - INDEXER_URL=https://demo.indexer:9200
      - WAZUH_API_URL=https://demo.manager:55000
      # ðŸ‘‡ ADD THESE TWO LINES BACK ðŸ‘‡
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword123!
    depends_on:
      - demo.manager
    mem_limit: 1g
    networks:
      - overwatch_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # THE AI CLIENT (Bank Node)
  ai_node_alpha:
    build: 
      context: ..
      dockerfile: Dockerfile.node
    container_name: ai_node_alpha
    privileged: true
    environment:
      - WAZUH_MANAGER_IP=demo.manager
      - WAZUH_AGENT_NAME=node_alpha
    depends_on:
      - demo.manager
      - verity.aggregator
    networks:
      - overwatch_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  overwatch_net:
    driver: bridge